#!/bin/bash

tmpdir="/tmp/"
tmpfile="${tmpdir}head_tmp.png"
overlay_img="$HOME/.local/share/icons/xlock/locked.png"

pre_png="${tmpdir}head_"
post_png=".png"
out="${tmpdir}screen.png"

debug=false

function timeit() {
	echo -ne "$@:\t"
	{ time { {
		$@
		TIMEFORMAT=$stat%2U;
	} 2>&3; } 2>&1; } 3>&2
}

function hw_info() {
	info="$(xdpyinfo -ext all 2>/dev/null | sed '/^  head #/!d;s///')"
	num_screens="$(echo "$info" | wc -l)"
	declare -gA hw_infos=()

	while IFS=' :x@,' read i w h x y; do
		hw_infos+=([${i}w]=$w [${i}h]=$h [${i}x]=$x [${i}y]=$y)
	done <<< "$info"
}

function get_info() {
	echo "${hw_infos[$1$2]}"
}

function screenshot() {
	for i in $(seq 0 $((num_screens - 1))); do
		import -window root \
			-crop "$(get_info $i w)x$(get_info $i h)+$(get_info $i x)+$(get_info $i y)" \
			"/tmp/head_$i.png"
		if $debug; then echo "import -window root -crop "$(get_info $i w)x$(get_info $i h)+$(get_info $i x)+$(get_info $i y)" \"/tmp/head_$i.png\""; fi
	done
}

function blurred() {
	convert $pre_png$1$post_png -blur 0x8 $pre_png$1$post_png
}

function overlay() {
	if [[ -f $overlay_img ]]; then
		convert $pre_png$1$post_png $overlay_img -gravity center -composite -matte $pre_png$1$post_png
	fi
}

function combine() {
	width="$(get_info 0 w)"
	heigth="$(get_info 0 h)"
	main="${pre_png}0$post_png"
	extended=""

	for i in $(seq 1 $((num_screens - 1))); do
		width=$(($width + $(get_info $i w)))
		extended+="-page +$(get_info $i x)+$(get_info $i y) $pre_png$i$post_png "
	done

	convert -page "${width}x${heigth}+0+0" $main $extended -flatten $out
}

timeit hw_info
timeit screenshot

for i in $(seq 0 $((num_screens - 1))); do
	timeit blurred $i
	timeit overlay $i
done

if [ "$num_screens" == 1 ]; then
	mv ${pre_png}0$post_png $out
else
	timeit combine
fi

i3lock -u -i $out
