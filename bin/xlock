#!/bin/bash

tmpdir="/tmp/"
tmpfile="${tmpdir}head_tmp.png"
overlay_img="$HOME/.local/share/icons/xlock/locked.png"

pre_png="${tmpdir}head_"
post_png=".png"
out="${tmpdir}screen.png"

laptop_pos="center"

debug=true

function timeit() {
	if $debug; then
		echo -ne "$@:\n"
		{ time { {
			$@
			echo -ne "\t"
			TIMEFORMAT="${stat}Sec: %2E CPU: %2U";
		} 2>&3; } 2>&1; } 3>&2
	else
		$@
	fi
}

function get_autorandr_profile() {
	local profile="$(autorandr_profile.sh)"
	if [[ $profile =~ (home|alta*) ]]; then
		laptop_pos="right"
	elif [ "$profile" == "office" ]; then
		laptop_pos="left"
	fi
}

function hw_info() {
	$debug && echo -e "\tlaptop_pos: $laptop_pos"

	info="$(xdpyinfo -ext all 2>/dev/null | sed '/^  head #/!d;s///')"
	num_screens="$(echo "$info" | wc -l)"
	declare -gA hw_infos=()

	while IFS=' :x@,' read i w h x y; do
		if [ "$laptop_pos" == "left" ]; then
			i=$(((i+1)%2))
		fi
		hw_infos+=([${i}w]=$w [${i}h]=$h [${i}x]=$x [${i}y]=$y)
		$debug && echo -e "\thw_infos+=([${i}w]=$w [${i}h]=$h [${i}x]=$x [${i}y]=$y)"
	done <<< "$info"
}

function get_info() {
	echo "${hw_infos[$1$2]}"
}

function screenshot() {
	for i in $(seq 0 $((num_screens - 1))); do
		local w=$(get_info $i w)
		local h=$(get_info $i h)
		local x=$(get_info $i x)
		local y=$(get_info $i y)
		local out="/tmp/head_$i.png"

		$debug && echo -e "\t$out:\t${w}x${h}+${x}+${y}"
		scrot -o -a ${x},${y},${w},${h} $out
	done
}

function blurred() {
	local _png=$pre_png$1$post_png
	gm convert $_png -scale 10% -blur 0x2.5 -resize 1000% $_png
}

function pixelize() {
	local _png=$pre_png$1$post_png
	pixelize.py $_png $_png 15
}

function overlay() {
	local _file="$pre_png$1$post_png"
	if [[ -f $overlay_img ]]; then
		gm composite -matte -gravity center $overlay_img $_file $_file
	fi
}

function combine() {
	width="$(get_info 0 w)"
	heigth="$(get_info 0 h)"
	x="$(get_info 0 x)"
	y="$(get_info 0 y)"
	main="${pre_png}0$post_png"
	extended=""

	for i in $(seq 1 $((num_screens - 1))); do
		width=$(($width + $(get_info $i w)))
		if (($(get_info $i h) > $heigth)); then
			heigth=$(get_info $i h)
		fi
		extended+="-page +$(get_info $i x)+$(get_info $i y) $pre_png$i$post_png "
	done

	$debug && echo -e "\tconvert -page \"${width}x${heigth}+$x+$y\" $main $extended -flatten $out"
	convert -page "${width}x${heigth}+$x+$y" $main $extended -flatten $out
}

timeit get_autorandr_profile
timeit hw_info
timeit screenshot

for i in $(seq 0 $((num_screens - 1))); do
	timeit blurred $i
	timeit pixelize $i
	timeit overlay $i
done

if [ "$num_screens" == 1 ]; then
	mv ${pre_png}0$post_png $out
else
	timeit combine
fi

i3lock -u -i $out
